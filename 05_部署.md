【240416】
# 清理服务器
```
在根目录查看各个文件夹的占用
du -h --max-depth=1 | sort -hr
排除挂了云盘的/home
find / -mindepth 1 -maxdepth 1 ! -name 'home' -type d -exec du -h --max-depth=0 {} \; 2>/dev/null | sort -hr
```
还是先取消onedrive挂载 systemctl stop rclone （systemctl start rclone）

![](assets/Pasted%20image%2020240416155143.png) ![](assets/Pasted%20image%2020240416155301.png) ![](assets/Pasted%20image%2020240416160845.png) ![](assets/Pasted%20image%2020240416160950.png) 

【可清理】/www/server/panel/data/ 这个是宝塔面板的监控的数据，在监控页面清空记录即可清理，30天的记录482M，清空记录后9.6M。以后保存天数改为7天吧

/www/server/nginx/src/openssl/test/ 这个文件夹很奇怪，其中有许多以_test结尾的文件，但还是不能删吧

![](assets/Pasted%20image%2020240416161329.png) 

【可清理】/www/wwwlog/ 是网站的日志，可以删，删除后可能不会继续记录日志，重启网站即可
/www/backup/oldData 其中应该是旧数据库的备份，可以挑大的删除
![](assets/Pasted%20image%2020240416170305.png) 

/www/backup/panel 应该是面板备份文件，按日期命名的zip，从4月2号到16号（今天），好像是自动删除的，不管了

清爽了很多
![](assets/Pasted%20image%2020240416171057.png) ![](assets/Pasted%20image%2020240416171148.png) ![](assets/Pasted%20image%2020240416171724.png) 
/usr 应该是没有能删的

【可清理】/var/log/
- /var/log/audit 删切割的就好
![](assets/Pasted%20image%2020240416172030.png) 
- /var/log/v2ray 删除后最好重启 v2ray restart
![](assets/Pasted%20image%2020240416172059.png) 

`yum clean all` 清除yum的缓存
![](assets/Pasted%20image%2020240416172841.png) ![](assets/Pasted%20image%2020240416173059.png) 

就先这样吧，好很多了
![](assets/Pasted%20image%2020240416173156.png) 
重启服务器试试吧，onedrive也重新挂载了，没问题
![](assets/Pasted%20image%2020240416174315.png)


## 后端部署尝试
宝塔面板 - 网站 - Node项目，安装Node版本管理器
安装node v14.17.6 稳定版
安装pnpm模块

> 现在在宝塔上看的磁盘占用是4.92G

给 e5share_node 提交一下，打标签 v1.1.1，导出为e5share_node-v1.1.1.zip

做最后的修改
- 数据库复制（第一次部署没有数据，不用进行）
- 用户jwt密钥 config.js: jwtConfig
- 管理员jwt密钥 config.js: jwtAdmin
- 管理员登录信息 admin/config.json

上传服务器 /www/wwwroot/e5share_node，解压

添加node项目 端口 54001
![](assets/Pasted%20image%2020240416195657.png) 
模块管理 一键安装模块，好像有问题，手动安装吧
```
[root@ser207523594653 e5share_node]# /www/server/nodejs/v14.17.6/bin/node /www/server/nodejs/v14.17.6/lib/node_modules/pnpm/bin/pnpm.cjs install
ERROR: This version of pnpm requires at least Node.js v16.14
The current version of Node.js is v14.17.6
Visit https://r.pnpm.io/comp to see the list of past pnpm versions with respective Node.js version support.
```
哦，原来是版本不对导致安装失败
现在卸载原来的v14.17.6，选择官方源，安装 v16.20.2 稳定版
还是失败，再手动试试吧

```
[root@ser207523594653 e5share_node]# /www/server/nodejs/v16.20.2/bin/node /www/server/nodejs/v16.20.2/lib/node_modules/pnpm/bin/pnpm.cjs install
ERROR: This version of pnpm requires at least Node.js v18.12
The current version of Node.js is v16.20.2
Visit https://r.pnpm.io/comp to see the list of past pnpm versions with respective Node.js version support.
```
还是版本的问题，pnpm版本高了当前是9应该用8，稳定版好像是 pnpm@8.15.7
安装失败？那算了不用pnpm了，用npm吧
模块是安装好了，但是启动失败
哦哦哦，应该这样，启动命令
```
/www/server/nodejs/v16.20.2/bin/node /www/wwwroot/e5share_node/app.js
```
启动成功了但是一会又坏了
报错 
```
Error: /lib64/libstdc++.so.6: version `CXXABI_1.3.8' not found
```
真你娘了麻烦😡
失败🙃，趁这个机会学学docker吧😇

# 后端部署

## docker打包尝试
优化了后端项目
- 通过环境变量来配置监听端口，默认端口暂定为`23769`
- 通过环境变量来配置jwt
- 更改了存放数据库的位置，为 data/

项目打标签v1.1.3，导出e5share_node-v1.1.3，上传解压

编写dockerfile
```
# 使用 Node.js 官方提供的 LTS 版本作为基础镜像
FROM node:16

# 配置环境变量
ENV TZ=Asia/Shanghai

# 设置工作目录
WORKDIR /app

# 复制 package.json 和 package-lock.json 文件到工作目录
COPY package*.json .

# 安装项目依赖
RUN npm install

# 复制应用程序代码到工作目录
COPY . .

# 暴露默认端口
EXPOSE 23769

# 定义容器启动时运行的命令
ENTRYPOINT ["node", "app.js"]
```

上传、构建
```
docker build -t e5share_node:1.1.3 .
```

运行
```
docker run -d \
	--name e5share_node \
	-p 23769:23769 \
	e5share_node:1.1.3
```

报错node版本不行，重新构建 `node:18.17.0`
失败🙃

又尝试`node:20`，构建时失败，好像是遇见过的，需要设置代理，以不在本地编译而从远程服务器下载预编译的二进制包。

设置代理试试
```
export http_proxy=http://192.168.2.110:10811/
export https_proxy=http://192.168.2.110:10811/
```
好像应该给dockerfile里也设置环境变量配置代理，不过npm安装模块之后要取消
```
# 设置代理
ENV http_proxy=http://192.168.2.110:10811/
ENV https_proxy=http://192.168.2.110:10811/

# 安装项目依赖
RUN npm install

# 取消代理
ENV http_proxy=
ENV https_proxy=
```

还是启动之后没有日志，也没有成功运行
测试一下
```
docker run -it --entrypoint /bin/bash e5share_node:1.1.3

root@a517c86189c3:/app# node app.js 
Illegal instruction (core dumped)
```
失败

尝试在 `RUN npm install` 后添加：
```
RUN npm rebuild sharp
RUN npm rebuild sqlite3
```
但还是不行
而node test.js却可以成功输出

使用 `docker exec -it quirky_jemison bash` 进入了容器
先后尝试了npm安装模块，pnpm安装模块，都不行

最后在代码中删除了sharp模块相关的内容，代码成功运行了，看来是sharp的问题导致`Illegal instruction (core dumped)`
只要在代码中导入就会出现问题，那现在就来试试还有什么图像处理模块可以用

好像jimp不错，Jimp 是一个纯 JavaScript 编写的图像处理库，它可以在 Node.js 环境中直接使用，不需要依赖于外部工具。Jimp 提供了丰富的图像处理功能，包括调整大小、裁剪、旋转、添加滤镜等。

```bash
pnpm install jimp
```

代码修改完成，准备重新构建

## docker打包

需要创建的数据卷：
- /root/e5share_node/data:/app/data
- /root/e5share_node/logs:/app/logs
- /root/e5share_node/uploads:/app/uploads

选用 node:20.12.2-bullseye-slim [【docker】如何挑选node_docker镜像](笔记/docker.md#如何挑选node_docker镜像)

Dockerfile
```Dockerfile
# FROM node:20.12.2-bullseye-slim
# 使用更小的 node:20.12.2-alpine3.19
FROM node:20.12.2-alpine3.19

# 配置环境变量
ENV TZ=Asia/Shanghai

# 设置工作目录
WORKDIR /app

# 复制 package.json 和 pnpm-lock.yaml 文件到工作目录
COPY package.json .
COPY pnpm-lock.yaml .

# 设置代理
ENV http_proxy=http://192.168.2.110:10811/
ENV https_proxy=http://192.168.2.110:10811/

# 安装 pnpm
RUN npm install -g pnpm

# 安装项目依赖
RUN pnpm install

# 取消代理
ENV http_proxy=
ENV https_proxy=

# 复制应用程序代码到工作目录
COPY . .

# 暴露默认端口
EXPOSE 23769

# 定义容器启动时运行的命令
ENTRYPOINT ["node", "app.js"]
```

构建
```
docker build -t e5share_node:1.1.4 .
```

镜像大小314MB，应该还能优化

运行
```sh
docker run -d \
	--name e5share_node \
	-p 23769:23769 \
	-v /root/e5share_node/data:/app/data \
	-v /root/e5share_node/logs:/app/logs \
	-v /root/e5share_node/uploads:/app/uploads \
	e5share_node:1.1.4
```

成功，要哭了😭

再试试 node:20.12.2-alpine3.19，同样成功，大小为242MB，就这样吧

再完善了一下，将jwtKeys.json移动至/data/jwtKeys.json，提交，标签为v1.1.5，导出上传解压。
```sh
docker build -t e5share_node:1.1.5 .

docker run -d \
	--name e5share_node \
	-p 23769:23769 \
	-v /root/e5share_node/data:/app/data \
	-v /root/e5share_node/logs:/app/logs \
	-v /root/e5share_node/uploads:/app/uploads \
	e5share_node:1.1.5
```

打包导出
```
docker save -o e5share_node_1.1.5.tar e5share_node:1.1.5
```

## 部署
上传打包后的镜像，加载镜像，之后删除包
```
docker load -i e5share_node_1.1.5.tar
```

运行容器，ok

域名 https://e5node.sakiko.top ，配置ssl，开启强制https，配置反向代理。ok

尝试让头像使用nginx来分发，添加站点e5avatar.sakiko.top，根目录设置为/root/e5share_node/uploads/avatar，好像因为目录路径问题不行，要修改一下数据卷映射，重新创建容器
```sh
docker run -d \
	--name e5share_node \
	-p 23769:23769 \
	-v /root/e5share_node/data:/app/data \
	-v /root/e5share_node/logs:/app/logs \
	-v /www/wwwroot/e5avatar.sakiko.top:/app/uploads/avatar \
	e5share_node:1.1.5
```
ok，现在头像地址为 https://e5avatar.sakiko.top

# 前端部署
完善前端，提交，合并到主分支，标签v1.1.1，

网站的基地址为 https://e5.sakiko.top

pnpm build，压缩上传解压

添加站点 https://e5.sakiko.top ，修改配置文件，添加：
```nginx
# 支持 Vue Router 的历史模式
location / {
	try_files $uri $uri/ /index.html;
}
```

完成！管理系统也部署了