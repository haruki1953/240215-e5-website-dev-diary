【240416】
# 清理服务器
```
在根目录查看各个文件夹的占用
du -h --max-depth=1 | sort -hr
排除挂了云盘的/home
find / -mindepth 1 -maxdepth 1 ! -name 'home' -type d -exec du -h --max-depth=0 {} \; 2>/dev/null | sort -hr
```
还是先取消onedrive挂载 systemctl stop rclone （systemctl start rclone）

![](assets/Pasted%20image%2020240416155143.png) ![](assets/Pasted%20image%2020240416155301.png) ![](assets/Pasted%20image%2020240416160845.png) ![](assets/Pasted%20image%2020240416160950.png) 

【可清理】/www/server/panel/data/ 这个是宝塔面板的监控的数据，在监控页面清空记录即可清理，30天的记录482M，清空记录后9.6M。以后保存天数改为7天吧

/www/server/nginx/src/openssl/test/ 这个文件夹很奇怪，其中有许多以_test结尾的文件，但还是不能删吧

![](assets/Pasted%20image%2020240416161329.png) 

【可清理】/www/wwwlog/ 是网站的日志，可以删，删除后可能不会继续记录日志，重启网站即可
/www/backup/oldData 其中应该是旧数据库的备份，可以挑大的删除
![](assets/Pasted%20image%2020240416170305.png) 

/www/backup/panel 应该是面板备份文件，按日期命名的zip，从4月2号到16号（今天），好像是自动删除的，不管了

清爽了很多
![](assets/Pasted%20image%2020240416171057.png) ![](assets/Pasted%20image%2020240416171148.png) ![](assets/Pasted%20image%2020240416171724.png) 
/usr 应该是没有能删的

【可清理】/var/log/
- /var/log/audit 删切割的就好
![](assets/Pasted%20image%2020240416172030.png) 
- /var/log/v2ray 删除后最好重启 v2ray restart
![](assets/Pasted%20image%2020240416172059.png) 

`yum clean all` 清除yum的缓存
![](assets/Pasted%20image%2020240416172841.png) ![](assets/Pasted%20image%2020240416173059.png) 

就先这样吧，好很多了
![](assets/Pasted%20image%2020240416173156.png) 
重启服务器试试吧，onedrive也重新挂载了，没问题
![](assets/Pasted%20image%2020240416174315.png)


# 后端部署
宝塔面板 - 网站 - Node项目，安装Node版本管理器
安装node v14.17.6 稳定版
安装pnpm模块

> 现在在宝塔上看的磁盘占用是4.92G

给 e5share_node 提交一下，打标签 v1.1.1，导出为e5share_node-v1.1.1.zip

做最后的修改
- 数据库复制（第一次部署没有数据，不用进行）
- 用户jwt密钥 config.js: jwtConfig
- 管理员jwt密钥 config.js: jwtAdmin
- 管理员登录信息 admin/config.json

上传服务器 /www/wwwroot/e5share_node，解压

添加node项目 端口 54001
![](assets/Pasted%20image%2020240416195657.png) 
模块管理 一键安装模块，好像有问题，手动安装吧
```
[root@ser207523594653 e5share_node]# /www/server/nodejs/v14.17.6/bin/node /www/server/nodejs/v14.17.6/lib/node_modules/pnpm/bin/pnpm.cjs install
ERROR: This version of pnpm requires at least Node.js v16.14
The current version of Node.js is v14.17.6
Visit https://r.pnpm.io/comp to see the list of past pnpm versions with respective Node.js version support.
```
哦，原来是版本不对导致安装失败
现在卸载原来的v14.17.6，选择官方源，安装 v16.20.2 稳定版
还是失败，再手动试试吧

```
[root@ser207523594653 e5share_node]# /www/server/nodejs/v16.20.2/bin/node /www/server/nodejs/v16.20.2/lib/node_modules/pnpm/bin/pnpm.cjs install
ERROR: This version of pnpm requires at least Node.js v18.12
The current version of Node.js is v16.20.2
Visit https://r.pnpm.io/comp to see the list of past pnpm versions with respective Node.js version support.
```
还是版本的问题，pnpm版本高了当前是9应该用8，稳定版好像是 pnpm@8.15.7
安装失败？那算了不用pnpm了，用npm吧
模块是安装好了，但是启动失败
哦哦哦，应该这样，启动命令
```
/www/server/nodejs/v16.20.2/bin/node /www/wwwroot/e5share_node/app.js
```
启动成功了但是一会又坏了
报错 
```
Error: /lib64/libstdc++.so.6: version `CXXABI_1.3.8' not found
```
真你娘了麻烦😡
失败🙃，趁这个机会学学docker吧😇

# 后端docker部署
优化了后端项目
- 通过环境变量来配置监听端口，默认端口暂定为`23769`
- 通过环境变量来配置jwt
- 更改了存放数据库的位置，为 data/

项目打标签v1.1.3，导出e5share_node-v1.1.3，上传解压

编写dockerfile
```
# 使用 Node.js 官方提供的 LTS 版本作为基础镜像
FROM node:16

# 配置环境变量
ENV TZ=Asia/Shanghai

# 设置工作目录
WORKDIR /app

# 复制 package.json 和 package-lock.json 文件到工作目录
COPY package*.json .

# 安装项目依赖
RUN npm install

# 复制应用程序代码到工作目录
COPY . .

# 暴露默认端口
EXPOSE 23769

# 定义容器启动时运行的命令
ENTRYPOINT ["node", "app.js"]
```

上传、构建
```
docker build -t e5share_node:1.1.3 .

```

运行
```
docker run -d \
	--name e5share_node \
	-p 23769:23769 \
	e5share_node:1.1.3
```

报错node版本不行，重新构建 `node:18.17.0`
失败🙃