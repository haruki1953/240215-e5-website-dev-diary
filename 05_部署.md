ã€240416ã€‘
# æ¸…ç†æœåŠ¡å™¨
```
åœ¨æ ¹ç›®å½•æŸ¥çœ‹å„ä¸ªæ–‡ä»¶å¤¹çš„å ç”¨
du -h --max-depth=1 | sort -hr
æ’é™¤æŒ‚äº†äº‘ç›˜çš„/home
find / -mindepth 1 -maxdepth 1 ! -name 'home' -type d -exec du -h --max-depth=0 {} \; 2>/dev/null | sort -hr
```
è¿˜æ˜¯å…ˆå–æ¶ˆonedriveæŒ‚è½½ systemctl stop rclone ï¼ˆsystemctl start rcloneï¼‰

![](assets/Pasted%20image%2020240416155143.png) ![](assets/Pasted%20image%2020240416155301.png) ![](assets/Pasted%20image%2020240416160845.png) ![](assets/Pasted%20image%2020240416160950.png) 

ã€å¯æ¸…ç†ã€‘/www/server/panel/data/ è¿™ä¸ªæ˜¯å®å¡”é¢æ¿çš„ç›‘æ§çš„æ•°æ®ï¼Œåœ¨ç›‘æ§é¡µé¢æ¸…ç©ºè®°å½•å³å¯æ¸…ç†ï¼Œ30å¤©çš„è®°å½•482Mï¼Œæ¸…ç©ºè®°å½•å9.6Mã€‚ä»¥åä¿å­˜å¤©æ•°æ”¹ä¸º7å¤©å§

/www/server/nginx/src/openssl/test/ è¿™ä¸ªæ–‡ä»¶å¤¹å¾ˆå¥‡æ€ªï¼Œå…¶ä¸­æœ‰è®¸å¤šä»¥_testç»“å°¾çš„æ–‡ä»¶ï¼Œä½†è¿˜æ˜¯ä¸èƒ½åˆ å§

![](assets/Pasted%20image%2020240416161329.png) 

ã€å¯æ¸…ç†ã€‘/www/wwwlog/ æ˜¯ç½‘ç«™çš„æ—¥å¿—ï¼Œå¯ä»¥åˆ ï¼Œåˆ é™¤åå¯èƒ½ä¸ä¼šç»§ç»­è®°å½•æ—¥å¿—ï¼Œé‡å¯ç½‘ç«™å³å¯
/www/backup/oldData å…¶ä¸­åº”è¯¥æ˜¯æ—§æ•°æ®åº“çš„å¤‡ä»½ï¼Œå¯ä»¥æŒ‘å¤§çš„åˆ é™¤
![](assets/Pasted%20image%2020240416170305.png) 

/www/backup/panel åº”è¯¥æ˜¯é¢æ¿å¤‡ä»½æ–‡ä»¶ï¼ŒæŒ‰æ—¥æœŸå‘½åçš„zipï¼Œä»4æœˆ2å·åˆ°16å·ï¼ˆä»Šå¤©ï¼‰ï¼Œå¥½åƒæ˜¯è‡ªåŠ¨åˆ é™¤çš„ï¼Œä¸ç®¡äº†

æ¸…çˆ½äº†å¾ˆå¤š
![](assets/Pasted%20image%2020240416171057.png) ![](assets/Pasted%20image%2020240416171148.png) ![](assets/Pasted%20image%2020240416171724.png) 
/usr åº”è¯¥æ˜¯æ²¡æœ‰èƒ½åˆ çš„

ã€å¯æ¸…ç†ã€‘/var/log/
- /var/log/audit åˆ åˆ‡å‰²çš„å°±å¥½
![](assets/Pasted%20image%2020240416172030.png) 
- /var/log/v2ray åˆ é™¤åæœ€å¥½é‡å¯ v2ray restart
![](assets/Pasted%20image%2020240416172059.png) 

`yum clean all` æ¸…é™¤yumçš„ç¼“å­˜
![](assets/Pasted%20image%2020240416172841.png) ![](assets/Pasted%20image%2020240416173059.png) 

å°±å…ˆè¿™æ ·å§ï¼Œå¥½å¾ˆå¤šäº†
![](assets/Pasted%20image%2020240416173156.png) 
é‡å¯æœåŠ¡å™¨è¯•è¯•å§ï¼Œonedriveä¹Ÿé‡æ–°æŒ‚è½½äº†ï¼Œæ²¡é—®é¢˜
![](assets/Pasted%20image%2020240416174315.png)


## åç«¯éƒ¨ç½²å°è¯•
å®å¡”é¢æ¿ - ç½‘ç«™ - Nodeé¡¹ç›®ï¼Œå®‰è£…Nodeç‰ˆæœ¬ç®¡ç†å™¨
å®‰è£…node v14.17.6 ç¨³å®šç‰ˆ
å®‰è£…pnpmæ¨¡å—

> ç°åœ¨åœ¨å®å¡”ä¸Šçœ‹çš„ç£ç›˜å ç”¨æ˜¯4.92G

ç»™ e5share_node æäº¤ä¸€ä¸‹ï¼Œæ‰“æ ‡ç­¾ v1.1.1ï¼Œå¯¼å‡ºä¸ºe5share_node-v1.1.1.zip

åšæœ€åçš„ä¿®æ”¹
- æ•°æ®åº“å¤åˆ¶ï¼ˆç¬¬ä¸€æ¬¡éƒ¨ç½²æ²¡æœ‰æ•°æ®ï¼Œä¸ç”¨è¿›è¡Œï¼‰
- ç”¨æˆ·jwtå¯†é’¥ config.js: jwtConfig
- ç®¡ç†å‘˜jwtå¯†é’¥ config.js: jwtAdmin
- ç®¡ç†å‘˜ç™»å½•ä¿¡æ¯ admin/config.json

ä¸Šä¼ æœåŠ¡å™¨ /www/wwwroot/e5share_nodeï¼Œè§£å‹

æ·»åŠ nodeé¡¹ç›® ç«¯å£ 54001
![](assets/Pasted%20image%2020240416195657.png) 
æ¨¡å—ç®¡ç† ä¸€é”®å®‰è£…æ¨¡å—ï¼Œå¥½åƒæœ‰é—®é¢˜ï¼Œæ‰‹åŠ¨å®‰è£…å§
```
[root@ser207523594653 e5share_node]# /www/server/nodejs/v14.17.6/bin/node /www/server/nodejs/v14.17.6/lib/node_modules/pnpm/bin/pnpm.cjs install
ERROR: This version of pnpm requires at least Node.js v16.14
The current version of Node.js is v14.17.6
Visit https://r.pnpm.io/comp to see the list of past pnpm versions with respective Node.js version support.
```
å“¦ï¼ŒåŸæ¥æ˜¯ç‰ˆæœ¬ä¸å¯¹å¯¼è‡´å®‰è£…å¤±è´¥
ç°åœ¨å¸è½½åŸæ¥çš„v14.17.6ï¼Œé€‰æ‹©å®˜æ–¹æºï¼Œå®‰è£… v16.20.2 ç¨³å®šç‰ˆ
è¿˜æ˜¯å¤±è´¥ï¼Œå†æ‰‹åŠ¨è¯•è¯•å§

```
[root@ser207523594653 e5share_node]# /www/server/nodejs/v16.20.2/bin/node /www/server/nodejs/v16.20.2/lib/node_modules/pnpm/bin/pnpm.cjs install
ERROR: This version of pnpm requires at least Node.js v18.12
The current version of Node.js is v16.20.2
Visit https://r.pnpm.io/comp to see the list of past pnpm versions with respective Node.js version support.
```
è¿˜æ˜¯ç‰ˆæœ¬çš„é—®é¢˜ï¼Œpnpmç‰ˆæœ¬é«˜äº†å½“å‰æ˜¯9åº”è¯¥ç”¨8ï¼Œç¨³å®šç‰ˆå¥½åƒæ˜¯ pnpm@8.15.7
å®‰è£…å¤±è´¥ï¼Ÿé‚£ç®—äº†ä¸ç”¨pnpmäº†ï¼Œç”¨npmå§
æ¨¡å—æ˜¯å®‰è£…å¥½äº†ï¼Œä½†æ˜¯å¯åŠ¨å¤±è´¥
å“¦å“¦å“¦ï¼Œåº”è¯¥è¿™æ ·ï¼Œå¯åŠ¨å‘½ä»¤
```
/www/server/nodejs/v16.20.2/bin/node /www/wwwroot/e5share_node/app.js
```
å¯åŠ¨æˆåŠŸäº†ä½†æ˜¯ä¸€ä¼šåˆåäº†
æŠ¥é”™ 
```
Error: /lib64/libstdc++.so.6: version `CXXABI_1.3.8' not found
```
çœŸä½ å¨˜äº†éº»çƒ¦ğŸ˜¡
å¤±è´¥ğŸ™ƒï¼Œè¶è¿™ä¸ªæœºä¼šå­¦å­¦dockerå§ğŸ˜‡

# åç«¯éƒ¨ç½²

## dockeræ‰“åŒ…å°è¯•
ä¼˜åŒ–äº†åç«¯é¡¹ç›®
- é€šè¿‡ç¯å¢ƒå˜é‡æ¥é…ç½®ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ç«¯å£æš‚å®šä¸º`23769`
- é€šè¿‡ç¯å¢ƒå˜é‡æ¥é…ç½®jwt
- æ›´æ”¹äº†å­˜æ”¾æ•°æ®åº“çš„ä½ç½®ï¼Œä¸º data/

é¡¹ç›®æ‰“æ ‡ç­¾v1.1.3ï¼Œå¯¼å‡ºe5share_node-v1.1.3ï¼Œä¸Šä¼ è§£å‹

ç¼–å†™dockerfile
```
# ä½¿ç”¨ Node.js å®˜æ–¹æä¾›çš„ LTS ç‰ˆæœ¬ä½œä¸ºåŸºç¡€é•œåƒ
FROM node:16

# é…ç½®ç¯å¢ƒå˜é‡
ENV TZ=Asia/Shanghai

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ package.json å’Œ package-lock.json æ–‡ä»¶åˆ°å·¥ä½œç›®å½•
COPY package*.json .

# å®‰è£…é¡¹ç›®ä¾èµ–
RUN npm install

# å¤åˆ¶åº”ç”¨ç¨‹åºä»£ç åˆ°å·¥ä½œç›®å½•
COPY . .

# æš´éœ²é»˜è®¤ç«¯å£
EXPOSE 23769

# å®šä¹‰å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤
ENTRYPOINT ["node", "app.js"]
```

ä¸Šä¼ ã€æ„å»º
```
docker build -t e5share_node:1.1.3 .
```

è¿è¡Œ
```
docker run -d \
	--name e5share_node \
	-p 23769:23769 \
	e5share_node:1.1.3
```

æŠ¥é”™nodeç‰ˆæœ¬ä¸è¡Œï¼Œé‡æ–°æ„å»º `node:18.17.0`
å¤±è´¥ğŸ™ƒ

åˆå°è¯•`node:20`ï¼Œæ„å»ºæ—¶å¤±è´¥ï¼Œå¥½åƒæ˜¯é‡è§è¿‡çš„ï¼Œéœ€è¦è®¾ç½®ä»£ç†ï¼Œä»¥ä¸åœ¨æœ¬åœ°ç¼–è¯‘è€Œä»è¿œç¨‹æœåŠ¡å™¨ä¸‹è½½é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶åŒ…ã€‚

è®¾ç½®ä»£ç†è¯•è¯•
```
export http_proxy=http://192.168.2.110:10811/
export https_proxy=http://192.168.2.110:10811/
```
å¥½åƒåº”è¯¥ç»™dockerfileé‡Œä¹Ÿè®¾ç½®ç¯å¢ƒå˜é‡é…ç½®ä»£ç†ï¼Œä¸è¿‡npmå®‰è£…æ¨¡å—ä¹‹åè¦å–æ¶ˆ
```
# è®¾ç½®ä»£ç†
ENV http_proxy=http://192.168.2.110:10811/
ENV https_proxy=http://192.168.2.110:10811/

# å®‰è£…é¡¹ç›®ä¾èµ–
RUN npm install

# å–æ¶ˆä»£ç†
ENV http_proxy=
ENV https_proxy=
```

è¿˜æ˜¯å¯åŠ¨ä¹‹åæ²¡æœ‰æ—¥å¿—ï¼Œä¹Ÿæ²¡æœ‰æˆåŠŸè¿è¡Œ
æµ‹è¯•ä¸€ä¸‹
```
docker run -it --entrypoint /bin/bash e5share_node:1.1.3

root@a517c86189c3:/app# node app.js 
Illegal instruction (core dumped)
```
å¤±è´¥

å°è¯•åœ¨ `RUN npm install` åæ·»åŠ ï¼š
```
RUN npm rebuild sharp
RUN npm rebuild sqlite3
```
ä½†è¿˜æ˜¯ä¸è¡Œ
è€Œnode test.jså´å¯ä»¥æˆåŠŸè¾“å‡º

ä½¿ç”¨ `docker exec -it quirky_jemison bash` è¿›å…¥äº†å®¹å™¨
å…ˆåå°è¯•äº†npmå®‰è£…æ¨¡å—ï¼Œpnpmå®‰è£…æ¨¡å—ï¼Œéƒ½ä¸è¡Œ

æœ€ååœ¨ä»£ç ä¸­åˆ é™¤äº†sharpæ¨¡å—ç›¸å…³çš„å†…å®¹ï¼Œä»£ç æˆåŠŸè¿è¡Œäº†ï¼Œçœ‹æ¥æ˜¯sharpçš„é—®é¢˜å¯¼è‡´`Illegal instruction (core dumped)`
åªè¦åœ¨ä»£ç ä¸­å¯¼å…¥å°±ä¼šå‡ºç°é—®é¢˜ï¼Œé‚£ç°åœ¨å°±æ¥è¯•è¯•è¿˜æœ‰ä»€ä¹ˆå›¾åƒå¤„ç†æ¨¡å—å¯ä»¥ç”¨

å¥½åƒjimpä¸é”™ï¼ŒJimp æ˜¯ä¸€ä¸ªçº¯ JavaScript ç¼–å†™çš„å›¾åƒå¤„ç†åº“ï¼Œå®ƒå¯ä»¥åœ¨ Node.js ç¯å¢ƒä¸­ç›´æ¥ä½¿ç”¨ï¼Œä¸éœ€è¦ä¾èµ–äºå¤–éƒ¨å·¥å…·ã€‚Jimp æä¾›äº†ä¸°å¯Œçš„å›¾åƒå¤„ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬è°ƒæ•´å¤§å°ã€è£å‰ªã€æ—‹è½¬ã€æ·»åŠ æ»¤é•œç­‰ã€‚

```bash
pnpm install jimp
```

ä»£ç ä¿®æ”¹å®Œæˆï¼Œå‡†å¤‡é‡æ–°æ„å»º

## dockeræ‰“åŒ…

éœ€è¦åˆ›å»ºçš„æ•°æ®å·ï¼š
- /root/e5share_node/data:/app/data
- /root/e5share_node/logs:/app/logs
- /root/e5share_node/uploads:/app/uploads

é€‰ç”¨ node:20.12.2-bullseye-slim [ã€dockerã€‘å¦‚ä½•æŒ‘é€‰node_dockeré•œåƒ](ç¬”è®°/docker.md#å¦‚ä½•æŒ‘é€‰node_dockeré•œåƒ)

Dockerfile
```Dockerfile
# FROM node:20.12.2-bullseye-slim
# ä½¿ç”¨æ›´å°çš„ node:20.12.2-alpine3.19
FROM node:20.12.2-alpine3.19

# é…ç½®ç¯å¢ƒå˜é‡
ENV TZ=Asia/Shanghai

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ package.json å’Œ pnpm-lock.yaml æ–‡ä»¶åˆ°å·¥ä½œç›®å½•
COPY package.json .
COPY pnpm-lock.yaml .

# è®¾ç½®ä»£ç†
ENV http_proxy=http://192.168.2.110:10811/
ENV https_proxy=http://192.168.2.110:10811/

# å®‰è£… pnpm
RUN npm install -g pnpm

# å®‰è£…é¡¹ç›®ä¾èµ–
RUN pnpm install

# å–æ¶ˆä»£ç†
ENV http_proxy=
ENV https_proxy=

# å¤åˆ¶åº”ç”¨ç¨‹åºä»£ç åˆ°å·¥ä½œç›®å½•
COPY . .

# æš´éœ²é»˜è®¤ç«¯å£
EXPOSE 23769

# å®šä¹‰å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œçš„å‘½ä»¤
ENTRYPOINT ["node", "app.js"]
```

æ„å»º
```
docker build -t e5share_node:1.1.4 .
```

é•œåƒå¤§å°314MBï¼Œåº”è¯¥è¿˜èƒ½ä¼˜åŒ–

è¿è¡Œ
```sh
docker run -d \
	--name e5share_node \
	-p 23769:23769 \
	-v /root/e5share_node/data:/app/data \
	-v /root/e5share_node/logs:/app/logs \
	-v /root/e5share_node/uploads:/app/uploads \
	e5share_node:1.1.4
```

æˆåŠŸï¼Œè¦å“­äº†ğŸ˜­

å†è¯•è¯• node:20.12.2-alpine3.19ï¼ŒåŒæ ·æˆåŠŸï¼Œå¤§å°ä¸º242MBï¼Œå°±è¿™æ ·å§

å†å®Œå–„äº†ä¸€ä¸‹ï¼Œå°†jwtKeys.jsonç§»åŠ¨è‡³/data/jwtKeys.jsonï¼Œæäº¤ï¼Œæ ‡ç­¾ä¸ºv1.1.5ï¼Œå¯¼å‡ºä¸Šä¼ è§£å‹ã€‚
```sh
docker build -t e5share_node:1.1.5 .

docker run -d \
	--name e5share_node \
	-p 23769:23769 \
	-v /root/e5share_node/data:/app/data \
	-v /root/e5share_node/logs:/app/logs \
	-v /root/e5share_node/uploads:/app/uploads \
	e5share_node:1.1.5
```

æ‰“åŒ…å¯¼å‡º
```
docker save -o e5share_node_1.1.5.tar e5share_node:1.1.5
```

## éƒ¨ç½²
ä¸Šä¼ æ‰“åŒ…åçš„é•œåƒï¼ŒåŠ è½½é•œåƒï¼Œä¹‹ååˆ é™¤åŒ…
```
docker load -i e5share_node_1.1.5.tar
```

è¿è¡Œå®¹å™¨ï¼Œok

åŸŸå https://e5node.sakiko.top ï¼Œé…ç½®sslï¼Œå¼€å¯å¼ºåˆ¶httpsï¼Œé…ç½®åå‘ä»£ç†ã€‚ok

å°è¯•è®©å¤´åƒä½¿ç”¨nginxæ¥åˆ†å‘ï¼Œæ·»åŠ ç«™ç‚¹e5avatar.sakiko.topï¼Œæ ¹ç›®å½•è®¾ç½®ä¸º/root/e5share_node/uploads/avatarï¼Œå¥½åƒå› ä¸ºç›®å½•è·¯å¾„é—®é¢˜ä¸è¡Œï¼Œè¦ä¿®æ”¹ä¸€ä¸‹æ•°æ®å·æ˜ å°„ï¼Œé‡æ–°åˆ›å»ºå®¹å™¨
```sh
docker run -d \
	--name e5share_node \
	-p 23769:23769 \
	-v /root/e5share_node/data:/app/data \
	-v /root/e5share_node/logs:/app/logs \
	-v /www/wwwroot/e5avatar.sakiko.top:/app/uploads/avatar \
	e5share_node:1.1.5
```
okï¼Œç°åœ¨å¤´åƒåœ°å€ä¸º https://e5avatar.sakiko.top

# å‰ç«¯éƒ¨ç½²
å®Œå–„å‰ç«¯ï¼Œæäº¤ï¼Œåˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼Œæ ‡ç­¾v1.1.1ï¼Œ

ç½‘ç«™çš„åŸºåœ°å€ä¸º https://e5.sakiko.top

pnpm buildï¼Œå‹ç¼©ä¸Šä¼ è§£å‹

æ·»åŠ ç«™ç‚¹ https://e5.sakiko.top ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œæ·»åŠ ï¼š
```nginx
# æ”¯æŒ Vue Router çš„å†å²æ¨¡å¼
location / {
	try_files $uri $uri/ /index.html;
}
```

å®Œæˆï¼ç®¡ç†ç³»ç»Ÿä¹Ÿéƒ¨ç½²äº†