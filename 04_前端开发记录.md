前端地址 https://github.com/haruki1953/e5share_vue3.git

参考 [day12-day13-大事件管理系统](../240207vueNote/day12-day13-大事件管理系统.md)

首先使用默认样式，实现基本功能再说

# 一、初始化项目
## 1.1 pnpm 创建项目
创建项目：pnpm create vue  
	![](assets/Pasted%20image%2020240301114040.png) 
- 安装依赖：pnpm install
- 运行项目：pnpm dev

## 1.2 ESLint & prettier 配置代码风格
**配置文件 .eslintrc.cjs**  
```js
/* eslint-env node */
require('@rushstack/eslint-patch/modern-module-resolution')

module.exports = {
  root: true,
  extends: [
    'plugin:vue/vue3-essential',
    'eslint:recommended',
    '@vue/eslint-config-prettier/skip-formatting'
  ],
  parserOptions: {
    ecmaVersion: 'latest'
  },
  rules: {
    'prettier/prettier': [
      'warn',
      {
        singleQuote: true, // 单引号
        semi: false, // 无分号
        printWidth: 80, // 每行宽度至多80字符
        trailingComma: 'none', // 不加对象|数组最后逗号
        endOfLine: 'auto' // 换行符号不限制（win mac 不一致）
      }
    ],
    'vue/multi-word-component-names': [
      'warn',
      {
        ignores: ['index'] // vue组件名称多单词组成（忽略index.vue）
      }
    ],
    'vue/no-setup-props-destructure': ['off'], // 关闭 props 解构的校验
    // 💡 添加未定义变量错误提示，create-vue@3.6.3 关闭，这里加上是为了支持下一个章节演示。
    'no-undef': 'error'
  }
}
```

```json
// ESlint插件 + Vscode配置 实现自动格式化修复
"editor.codeActionsOnSave": {
    "source.fixAll": true
},
"editor.formatOnSave": false,
```

## 1.3 基于 husky 的代码检查工作流
git初始化 git init（创建版本库）

初始化 husky 工具配置  https://typicode.github.io/husky/
```sh
pnpm dlx husky-init && pnpm install
```

暂存区 eslint 校验 **lint-staged 配置**  
![](assets/Pasted%20image%2020240301121912.png)
1. 安装
```jsx
pnpm i lint-staged -D
```
2. 配置 `package.json`
```jsx
{
  // ... 省略 ...
  "lint-staged": {
    "*.{js,ts,vue}": [
      "eslint --fix"
    ]
  }
}

{
  "scripts": {
    // ... 省略 ...
    "lint-staged": "lint-staged"
  }
}
```
3. 修改 .husky/pre-commit 文件
```sh
# npm test 删掉
pnpm lint-staged
```

## 1.4 调整项目目录
### 删除文件
- 删除 src/assets 下的文件
- 删除 src/components 下的文件
- 删除 src/stores 下的文件
- 删除 src/views 下的文件

### 修改内容
`src/router/index.js` 初始化空路由
```jsx
import { createRouter, createWebHistory } from 'vue-router'

const router = createRouter({
  history: createWebHistory(import.meta.env.BASE_URL),
  routes: []
})

export default router
```
`src/App.vue`
```jsx
<script setup></script>

<template>
  <div>
    <!-- <router-view></router-view> -->
    我是app
  </div>
</template>

<style scoped></style>
```
`src/main.js`
```jsx
import { createApp } from 'vue'
import { createPinia } from 'pinia'

import App from './App.vue'
import router from './router'

const app = createApp(App)

app.use(createPinia())
app.use(router)
app.mount('#app')
```

### 新增目录
- src/api 
- src/utils

### 全局样式 图片文件 sass依赖
将项目需要的全局样式 和 图片文件，复制到 src/assets 文件夹中,  并将全局样式在main.js中引入
```jsx
import '@/assets/main.scss'
```

安装 sass 依赖
```jsx
pnpm add sass -D
```

## 1.5 引入 Element Plus 组件库
**官方文档：** https://element-plus.org/zh-CN/
- 安装
```sh
$ pnpm add element-plus
```

**自动按需：**
1. 安装插件
```sh
pnpm add -D unplugin-vue-components unplugin-auto-import
```

2. 然后把下列代码插入到你的 `Vite` 或 `Webpack` 的配置文件中
```jsx
...
import AutoImport from 'unplugin-auto-import/vite'
import Components from 'unplugin-vue-components/vite'
import { ElementPlusResolver } from 'unplugin-vue-components/resolvers'

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [
    ...
    AutoImport({
      resolvers: [ElementPlusResolver()]
    }),
    Components({
      resolvers: [ElementPlusResolver()]
    })
  ]
})
```
默认 components 下的文件也会被自动注册

## 1.7 Pinia
### 构建仓库 和 持久化
官方文档： https://prazdevs.github.io/pinia-plugin-persistedstate/zh/
![](assets/Pasted%20image%2020240301145637.png)
1. 安装自动持久化插件 pinia-plugin-persistedstate
```sh
pnpm add pinia-plugin-persistedstate -D
```

2. 使用 main.js
```jsx
import persist from 'pinia-plugin-persistedstate'
...
app.use(createPinia().use(persist))
```

3. 配置 stores/user.js
```jsx
import { defineStore } from 'pinia'
import { ref } from 'vue'

// 用户模块
export const useUserStore = defineStore(
  'big-user',
  () => {
    const token = ref('') // 定义 token
    const setToken = (t) => (token.value = t) // 设置 token

    return { token, setToken }
  },
  {
    persist: true // 持久化
  }
)
```

### Pinia 仓库统一管理
**pinia 独立维护**
- 现在：初始化代码在 main.js 中，仓库代码在 stores 中，代码分散职能不单一
- 优化：由 stores 统一维护，在 stores/index.js 中完成 pinia 初始化，交付 main.js 使用

**仓库 统一导出**
- 现在：使用一个仓库 `import { useUserStore } from ./stores/user.js` 不同仓库路径不一致
- 优化：由 stores/index.js 统一导出，导入路径统一 `./stores`，而且仓库维护在 stores/modules 中
[stores/index.js](project/day12-Vue3-big-event-admin/src/stores/index.js)  
```js
import { createPinia } from 'pinia'
import persist from 'pinia-plugin-persistedstate'

const pinia = createPinia()
pinia.use(persist)

export default pinia
export * from './modules/user'
export * from './modules/counter'

// import { useUserStore } from './modules/user'
// export { useUserStore }
// import { useCountStore } from './modules/counter'
// export { useCountStore }
```

## 1.8 数据交互 - 请求工具设计
### 创建 axios 实例
使用 axios 来请求后端接口, 一般都会对 axios 进行一些配置 (比如: 配置基础地址等)  
一般项目开发中, 都会对 axios 进行基本的二次封装, 单独封装到一个模块中, 便于使用

1. 安装 axios
```
pnpm add axios
```

2. 新建 `utils/request.js` 封装 axios 模块
    利用 axios.create 创建一个自定义的 axios 来使用  
    http://www.axios-js.com/zh-cn/docs/#axios-create-config  

### 完成 axios 基本配置
#### 请求拦截器中携带token - 访问pinia仓库
#### 响应拦截器中提示错误 - ElMessage
https://element-plus.org/zh-CN/component/message.html
```js
import axios from 'axios'
import { useUserStore } from '@/stores'
import { ElMessage } from 'element-plus'
import router from '@/router'
const baseURL = 'http://big-event-vue-api-t.itheima.net'

const instance = axios.create({
  // TODO 1. 基础地址，超时时间
  baseURL,
  timeout: 10000
})

// 请求拦截器
instance.interceptors.request.use(
  (config) => {
    // TODO 2. 携带token
    const useStore = useUserStore()
    if (useStore.token) {
      config.headers.Authorization = useStore.token
    }
    return config
  },
  (err) => Promise.reject(err)
)

// 响应拦截器
instance.interceptors.response.use(
  (res) => {
    // TODO 4. 摘取核心响应数据
    if (res.data.code === 0) {
      return res
    }
    // TODO 3. 处理业务失败
    // 处理业务失败, 给错误提示，抛出错误
    ElMessage.error(res.data.message || '服务异常')
    return Promise.reject(res.data)
  },
  (err) => {
    // TODO 5. 处理401错误
    // 错误的特殊情况 => 401 权限不足 或 token 过期 => 拦截到登录
    if (err.response?.status === 401) {
      router.push('/login')
    }

    // 错误的默认情况 => 只要给提示
    ElMessage.error(err.response.data.message || '服务异常')
    return Promise.reject(err)
  }
)

export default instance
export { baseURL }
```

## 1.9 整体路由设计