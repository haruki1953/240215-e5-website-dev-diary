后端地址 https://github.com/haruki1953/e5share_node.git

[参考：nodejs05_项目](../240117nodejsNote/05_项目.md)

# 一、初始化项目
## 1.1 创建项目
新建 e5share_node 文件夹作为项目根目录  
安装 express ：pnpm add express

创建 git 版本库，将 node_modules 文件夹加入忽略文件  

安装配置ESLint [node项目中使用ESLint](笔记/node项目中使用ESLint.md)

在项目根目录中新建 app.js 作为整个项目的入口文件，初始化一个基本的服务器  
```js
// 导入 express 模块
const express = require('express');
// 创建 express 的服务器实例
const app = express();

// write your code here...

// 调用 app.listen 方法，指定端口号并启动web服务器
app.listen(3007, () => {
  console.log('api server running at http://127.0.0.1:3007');
});
```
使用 nodemon app.js 来启动项目

## 1.2 配置 cors 跨域
运行如下的命令，安装 cors 中间件：pnpm add cors@2.8.5  
在 app.js 中导入并配置 cors 中间件：
```js
// 导入 cors 中间件
const cors = require('cors');
// 将 cors 注册为全局中间件
app.use(cors());
```

## 1.3 配置解析表单数据的中间件
```js
// 解析 JSON 格式的请求体数据
app.use(express.json());
```

## 1.4 初始化路由相关的文件夹
新建 /router 文件夹，用来存放所有的 路由 模块  
新建 /router_handler 文件夹，用来存放所有的 路由处理函数模块  

基本路由目录结构规划：
```
e5share_node/
├── router/
│   ├── authRouter.js              // 登录注册相关路由
│   ├── userRouter.js              // 用户相关路由
│   ├── publicRouter.js            // 公共接口路由
│   ├── postRouter.js              // e5动态相关路由
│   └── shareRouter.js             // e5分享相关路由
└── router_handler/
    ├── authHandler.js             // 登录注册相关路由处理函数
    ├── userHandler.js             // 用户相关路由处理函数
    ├── publicHandler.js           // 公共接口路由处理函数
    ├── postHandler.js             // e5动态相关路由处理函数
    └── shareHandler.js            // e5分享相关路由处理函数
```

## 1.5 初始化 auth 登录注册相关路由
/router/authRouter.js 文件，作为登录注册相关路由模块  
/router_handler/authHandler.js 文件，其中保存路由处理函数  


# 二、数据库创建与配置
创建文件夹 /db，用来存放sqlite数据库

安装Sequelize和SQLite：pnpm add sequelize sqlite3  
注意：好像因为缺少编译工具会报错，需要设置代理，以不在本地编译
```
pnpm config set proxy http://localhost:10809
pnpm config set https-proxy http://localhost:10809
```
当你运行`npm install sqlite3`命令时，npm会首先尝试从远程服务器下载预编译的二进制包。如果这个过程成功，那么就不需要在本地进行编译。然而，如果由于网络问题或者其他原因导致下载失败，npm会尝试在本地编译这些插件。

在项目中使用Sequelize
```
/
|-- db/
|   |-- index.js             // 创建 Sequelize 实例并连接数据库，导出
|   |-- initialize.js        // 定义初始化函数并导出
|   `-- database.sqlite      // SQLite 数据库文件
|-- models/
|   |-- index.js             // 导入并导出所有模型，方便使用
|   |-- user.js              
|   |-- user_notification.js 
|   |-- user_e5_post.js      
|   |-- users_e5_shared_info.js
|   `-- admin.js
`-- app.js                   // 引入初始化函数并启动服务器前进行数据库初始化
```


# 三、注册登录
## 错误处理
编写接口时，在路由处理函数中统一捕获错误，并返回错误响应  
通过 /services/errors/index 中的 errorHandler 判断错误并获取应该返回的 状态码status 和 信息message

将业务性操作抽离路由处理函数，新建 /services 文件夹，其中创建 `userService.js` 等文件，用于存放 用户相关操作 等业务性操作  
在 /services 中的文件中，操作数据库时要捕获错误，抛出在/services/errors/index中导入的ClientError，附上错误信息  

## 密码加密
安装： pnpm add bcryptjs@2.4.3
```js
// 导入
const bcrypt = require('bcryptjs')
// 加密 bcrypt.hashSync(明文密码, 随机盐的 长度)
const hashedPassword = bcrypt.hashSync(password, 10)
```

## 表单数据验证
安装
```sh
pnpm add joi@17.12.0
pnpm add @escook/express-joi@1.1.1
```
新建 /schema 文件夹，用于存放验证规则模块  
新建 /schema/userSchema.js 用户信息验证规则模块，定义验证规则

authRouter.js 中，导入验证表单数据的中间件、导入需要的验证规则对象  
在需要表单数据验证的路由中，声明局部中间件，对当前请求中携带的数据进行验证

在 app.js 的全局错误级别中间件中，捕获验证失败的错误，并把验证失败的结果响应给客户 端：

## 接口编写流程
**准备**
- 接口文档先写个大概
- 整理接口要干的事  
**代码**
- 先完成路由和路由处理函数，确保畅通
- 配置表单数据验证
- 编写业务逻辑  
**完善**
- 测试接口
- 完善接口文档


## 注册
- 表单数据验证
- 用户注册
	- 确认用户名不存在
	- 确认邮箱不存在
	- 密码哈希处理
	- 数据库创建新 用户、用户通知、用户动态、用户e5分享信息
- 错误捕获

## 用户名登录
- 表单数据验证
- 用户登录
	- 根据用户名获取用户，没有则抛出错误
	- 确认密码正确
	- 生成并返回token
- 错误捕获

#### 生成 JWT 的 Token 字符串
安装生成 Token 字符串的包：pnpm add jsonwebtoken@8.5.1
```js
// 用这个包来生成 Token 字符串 
const jwt = require('jsonwebtoken')

// 创建 config.js 文件，并向外共享 加密 和 还原 Token 的 jwtSecretKey 字符串：
exports.jwtConfig = {
	secretKey: 'itheima No1. ^_^', 
	expiresIn: '10h' // token 有效期为 10 个小时
}

// 将用户信息对象加密成 Token 字符串：
// 导入配置文件 
const { jwtConfig } = require('../config') 
// 配置负载

// 生成 Token 字符串 
const tokenStr = jwt.sign(user, jwtConfig.secretKey, { 
	expiresIn: jwtConfig.expiresIn, 
})

// 将生成的 Token 字符串响应给客户端：
// 为了方便客户端使用 Token，在服务器端直接拼接上 Bearer 的前缀 
{
    code: 0,
    message: "登录成功"
    token: 'Bearer ' + tokenStr
}

```


## 邮箱登录
- 表单数据验证
- 用户登录
	- 根据邮箱获取用户
	- 确认密码正确
	- 生成并返回token
- 错误捕获

# 四、用户相关接口
新建 userRouter.js 、 userHandler.js 与 userService.js

## 配置解析 Token 的中间件
安装解析 Token 的中间件：pnpm add express-jwt@5.3.3
```js
// 在 app.js 中注册路由之前，配置解析 Token 的中间件：
// 导入jwt配置文件
const { jwtConfig } = require('../config')
// 解析 token 的中间件 
const expressJWT = require('express-jwt') 
// 使用 .unless({ path: [/^\/api\//] }) 指定哪些接口不需要进行 Token 的身份认证 
app.use(expressJWT({ secret: jwtConfig.SecretKey }).unless({ path: [/^\/api\//] }))

// 在 app.js 中的 错误级别中间件 里面，捕获并处理 Token 认证失败后的错误：
if (err.name === 'UnauthorizedError') {
  return res.status(400).json({
    code: 1,
    message: '身份认证失败！',
  });
}
```
通过 `req.user` 可访问解析出的数据

## 获取个人信息
- 鉴权
- 获取个人信息
	- 根据id获取用户
	- 获取用户通知
	- 整理返回数据
	- 修改最后登录的时间
- 错误捕获

## 修改基本信息
- 鉴权
- 表单数据验证
- 修改个人信息
- 错误捕获